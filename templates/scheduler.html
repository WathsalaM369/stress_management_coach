<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Task Scheduler - MindSoothe</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .quick-action-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding: 15px;
            background: #f0f4ff;
            border-radius: 10px;
        }

        .quick-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .quick-btn.primary {
            background: #667eea;
            color: white;
        }

        .quick-btn.secondary {
            background: #e0e7ff;
            color: #667eea;
        }

        .quick-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .step {
            padding: 12px 25px;
            border-radius: 25px;
            background: #e0e7ff;
            color: #667eea;
            font-weight: bold;
            transition: all 0.3s;
        }

        .step.active {
            background: #667eea;
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .stress-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 25px;
            border-radius: 15px;
            color: white;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        }

        .stress-card h3 {
            margin-bottom: 10px;
            font-size: 1.5em;
        }

        .stress-score {
            font-size: 3em;
            font-weight: bold;
            margin: 10px 0;
        }

        .routine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-card {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e7ff;
            transition: all 0.3s;
        }

        .day-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .day-header {
            color: #667eea;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-slot {
            display: grid;
            grid-template-columns: auto 20px auto 1fr auto;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }

        .time-slot input[type="time"],
        .time-slot select {
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .time-slot input:focus,
        .time-slot select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-remove {
            background: #ef4444;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-add-slot {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            font-weight: bold;
        }

        .task-input-card {
            background: #f0f4ff;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .task-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1.5fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .task-form input,
        .task-form select {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .task-form input:focus,
        .task-form select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn-add-task {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .task-list {
            margin-top: 20px;
        }

        .task-item {
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .task-item.high { border-left-color: #ef4444; }
        .task-item.medium { border-left-color: #f59e0b; }
        .task-item.low { border-left-color: #10b981; }

        .task-info {
            flex: 1;
        }

        .task-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .task-details {
            font-size: 14px;
            color: #666;
        }

        .task-urgency {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .task-urgency.urgent {
            background: #fee2e2;
            color: #dc2626;
        }

        .task-urgency.normal {
            background: #dbeafe;
            color: #2563eb;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: block;
            margin: 30px auto;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            margin-top: 30px;
        }

        .day-column {
            background: #f8f9ff;
            border-radius: 12px;
            padding: 15px;
            min-height: 500px;
        }

        .day-column-header {
            font-weight: bold;
            color: #667eea;
            padding: 12px;
            background: white;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
        }

        .schedule-slot {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
            font-size: 13px;
            transition: all 0.3s;
        }

        .schedule-slot:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateX(3px);
        }

        .schedule-slot.work { border-left-color: #3b82f6; }
        .schedule-slot.break { border-left-color: #10b981; }
        .schedule-slot.urgent { border-left-color: #ef4444; }

        .slot-time {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .slot-task {
            color: #666;
            margin-bottom: 5px;
        }

        .slot-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .slot-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
        }

        .slot-btn.danger {
            background: #ef4444;
        }

        .warnings-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .warnings-box h3 {
            color: #d97706;
            margin-bottom: 15px;
        }

        .warning-item {
            padding: 10px;
            margin: 8px 0;
            color: #92400e;
            background: white;
            border-radius: 6px;
        }

        .suggestions-box {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .suggestions-box h3 {
            color: #1e40af;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            font-size: 20px;
            color: #667eea;
        }

        .loading-spinner {
            margin: 20px auto;
            border: 4px solid #e0e7ff;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .workload-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .workload-item {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }

        .workload-item.light {
            background: #d1fae5;
            color: #065f46;
        }

        .workload-item.balanced {
            background: #dbeafe;
            color: #1e40af;
        }

        .workload-item.heavy {
            background: #fee2e2;
            color: #991b1b;
        }

        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }

        .export-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .export-btn.calendar {
            background: #3b82f6;
        }

        .export-btn.calendar:hover {
            background: #2563eb;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .modal-btn.primary {
            background: #667eea;
            color: white;
        }

        .modal-btn.secondary {
            background: #e0e7ff;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üóìÔ∏è Smart Task Scheduler</h1>
        <p class="subtitle">AI-powered scheduling that adapts to your stress level</p>

        <div class="quick-action-bar" id="quickActions" style="display: none;">
            <button class="quick-btn secondary" onclick="editRoutine()">‚úèÔ∏è Edit Routine</button>
            <button class="quick-btn secondary" onclick="viewHistory()">üìä View History</button>
            <button class="quick-btn primary" onclick="skipToTasks()">‚ûï Add Tasks</button>
        </div>

        <div class="progress-steps">
            <div class="step active" id="step1">1. Routine</div>
            <div class="step" id="step2">2. Tasks</div>
            <div class="step" id="step3">3. Schedule</div>
        </div>

        <!-- Step 1: Routine Setup -->
        <div class="section" id="routineSection">
            <div class="section-title">Step 1: Your Weekly Routine</div>
            <p style="margin-bottom: 20px; color: #666;">
                Define your available time slots for each day. This helps the AI schedule tasks when you're actually free.
            </p>
            
            <div class="routine-grid" id="routineGrid"></div>
            <button class="btn-primary" onclick="saveRoutine()">üíæ Save Routine & Continue ‚Üí</button>
        </div>

        <!-- Step 2: Task Input -->
        <div class="section" id="taskSection" style="display: none;">
            <div class="section-title">Step 2: Add Your Tasks</div>
            
            <div id="stressCard" class="stress-card" style="display: none;">
                <h3>Your Current Stress Level</h3>
                <div class="stress-score" id="stressScore">5.0</div>
                <p id="stressInfo">Loading stress data...</p>
            </div>

            <div class="task-input-card">
                <h3 style="margin-bottom: 15px; color: #667eea;">Enter Task Details</h3>
                <div class="task-form">
                    <input type="text" id="taskName" placeholder="Task Name *" required>
                    <input type="number" id="taskDuration" placeholder="Hours *" min="0.5" step="0.5" required>
                    <select id="taskPriority">
                        <option value="high">üî¥ High Priority</option>
                        <option value="medium">üü° Medium Priority</option>
                        <option value="low">üü¢ Low Priority</option>
                    </select>
                    <input type="date" id="taskDeadline" placeholder="Deadline *" required>
                </div>
                <button class="btn-add-task" onclick="addTask()">‚ûï Add Task to List</button>
                <div class="task-list" id="taskList"></div>
            </div>
            
            <button class="btn-primary" onclick="generateSchedule()">üöÄ Generate Smart Schedule</button>
        </div>

        <!-- Step 3: Schedule Display -->
        <div class="section" id="scheduleSection" style="display: none;">
            <div class="section-title">Your Optimized Schedule</div>
            
            <div class="export-buttons">
                <button class="export-btn calendar" onclick="exportToGoogleCalendar()">üìÖ Add to Google Calendar</button>
                <button class="export-btn" onclick="downloadICal()">üì• Download .ics File</button>
                <button class="export-btn" onclick="printSchedule()">üñ®Ô∏è Print</button>
                <button class="export-btn" onclick="startOver()">üîÑ New Schedule</button>
            </div>
            
            <div id="warningsContainer"></div>
            <div id="suggestionsContainer"></div>
            <div id="workloadContainer"></div>
            
            <div class="calendar-view" id="calendarView"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="loading-spinner"></div>
            <h3>ü§ñ Generating Your Personalized Schedule...</h3>
            <p>Analyzing stress levels, deadlines, and optimizing task placement...</p>
        </div>
    </div>

    <!-- Modal for routine confirmation -->
    <div id="routineModal" class="modal">
        <div class="modal-content">
            <div class="modal-title">Existing Routine Found</div>
            <p>You have a saved weekly routine. Would you like to use it or create a new one?</p>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="loadExistingRoutine()">Use Saved Routine</button>
                <button class="modal-btn secondary" onclick="createNewRoutine()">Create New</button>
            </div>
        </div>
    </div>

    <script>
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let tasks = [];
        let weeklyRoutine = {};
        let stressData = null;
        let hasExistingRoutine = false;
        let currentScheduleData = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await checkUserStatus();
        });

        async function checkUserStatus() {
            try {
                const response = await fetch('/api/scheduler/check-status');
                const data = await response.json();
                
                // Check stress assessment
                if (data.has_stress_assessment && data.stress_data) {
                    stressData = data.stress_data;
                    console.log('‚úÖ Stress data loaded:', stressData);
                } else {
                    alert('‚ö†Ô∏è Please complete a stress assessment first!\n\nGo to the main page to assess your stress level before scheduling tasks.');
                    window.location.href = '/';
                    return;
                }

                // Check existing routine
                if (data.has_routine) {
                    hasExistingRoutine = true;
                    document.getElementById('routineModal').classList.add('show');
                } else {
                    initRoutineSetup();
                }
            } catch (error) {
                console.error('‚ùå Error checking status:', error);
                alert('Error connecting to server. Please try again.');
            }
        }

        async function loadExistingRoutine() {
            try {
                const response = await fetch('/api/scheduler/get-routine');
                const data = await response.json();
                
                if (data.status === 'success') {
                    weeklyRoutine = data.routine.weekly_routine;
                    document.getElementById('routineModal').classList.remove('show');
                    document.getElementById('quickActions').style.display = 'flex';
                    skipToTasks();
                }
            } catch (error) {
                console.error('‚ùå Error loading routine:', error);
                createNewRoutine();
            }
        }

        function createNewRoutine() {
            document.getElementById('routineModal').classList.remove('show');
            initRoutineSetup();
        }

        function initRoutineSetup() {
            const grid = document.getElementById('routineGrid');
            grid.innerHTML = '';
            
            days.forEach(day => {
                const dayCard = document.createElement('div');
                dayCard.className = 'day-card';
                dayCard.innerHTML = `
                    <div class="day-header">
                        <span>${day}</span>
                        <button class="btn-add-slot" onclick="addTimeSlot('${day}')">+ Slot</button>
                    </div>
                    <div id="${day}-slots">
                        ${createDefaultSlot(day)}
                    </div>
                `;
                grid.appendChild(dayCard);
            });
        }

        function createDefaultSlot(day) {
            return `
                <div class="time-slot">
                    <input type="time" value="09:00">
                    <span>-</span>
                    <input type="time" value="17:00">
                    <select>
                        <option value="work">üíº Work</option>
                        <option value="hobby">üé® Hobby</option>
                        <option value="exercise">üèÉ Exercise</option>
                        <option value="leisure">üéÆ Leisure</option>
                        <option value="sleep">üò¥ Sleep</option>
                        <option value="blocked">üö´ Blocked</option>
                    </select>
                    <button class="btn-remove" onclick="removeSlot(this)" style="visibility:hidden;">√ó</button>
                </div>
            `;
        }

        function addTimeSlot(day) {
            const slotsDiv = document.getElementById(`${day}-slots`);
            const slotDiv = document.createElement('div');
            slotDiv.className = 'time-slot';
            slotDiv.innerHTML = `
                <input type="time" value="14:00">
                <span>-</span>
                <input type="time" value="18:00">
                <select>
                    <option value="work">üíº Work</option>
                    <option value="hobby">üé® Hobby</option>
                    <option value="exercise">üèÉ Exercise</option>
                    <option value="leisure">üéÆ Leisure</option>
                    <option value="sleep">üò¥ Sleep</option>
                    <option value="blocked">üö´ Blocked</option>
                </select>
                <button class="btn-remove" onclick="removeSlot(this)">√ó</button>
            `;
            slotsDiv.appendChild(slotDiv);
        }

        function removeSlot(button) {
            button.parentElement.remove();
        }

        async function saveRoutine() {
            weeklyRoutine = {};
            let hasWork = false;

            days.forEach(day => {
                const slots = document.querySelectorAll(`#${day}-slots .time-slot`);
                weeklyRoutine[day] = [];
                
                slots.forEach(slot => {
                    const inputs = slot.querySelectorAll('input[type="time"]');
                    const select = slot.querySelector('select');
                    const type = select.value;
                    
                    if (type === 'work') hasWork = true;
                    
                    weeklyRoutine[day].push({
                        start: inputs[0].value,
                        end: inputs[1].value,
                        type: type
                    });
                });
            });

            if (!hasWork) {
                alert('‚ö†Ô∏è Please add at least one "Work" time slot for task scheduling.');
                return;
            }

            try {
                const response = await fetch('/api/scheduler/save-routine', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ routine: weeklyRoutine })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    document.getElementById('step1').classList.add('completed');
                    document.getElementById('step2').classList.add('active');
                    document.getElementById('routineSection').style.display = 'none';
                    document.getElementById('taskSection').style.display = 'block';
                    document.getElementById('quickActions').style.display = 'flex';
                    
                    displayStressInfo();
                } else {
                    alert('‚ùå Error saving routine: ' + data.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
            }
        }

        function displayStressInfo() {
            if (stressData) {
                const card = document.getElementById('stressCard');
                const score = document.getElementById('stressScore');
                const info = document.getElementById('stressInfo');
                
                card.style.display = 'block';
                score.textContent = `${stressData.stress_score}/10`;
                info.innerHTML = `
                    <strong>${stressData.stress_level}</strong> stress level detected<br>
                    The AI will optimize your schedule accordingly
                `;
            }
        }

        function skipToTasks() {
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');
            document.getElementById('routineSection').style.display = 'none';
            document.getElementById('taskSection').style.display = 'block';
            displayStressInfo();
        }

        function editRoutine() {
            document.getElementById('step1').classList.remove('completed');
            document.getElementById('step2').classList.remove('active');
            document.getElementById('routineSection').style.display = 'block';
            document.getElementById('taskSection').style.display = 'none';
            document.getElementById('scheduleSection').style.display = 'none';
            
            // Populate form with existing routine
            days.forEach(day => {
                const slotsDiv = document.getElementById(`${day}-slots`);
                slotsDiv.innerHTML = '';
                
                const dayRoutine = weeklyRoutine[day] || [];
                dayRoutine.forEach(slot => {
                    const slotDiv = document.createElement('div');
                    slotDiv.className = 'time-slot';
                    slotDiv.innerHTML = `
                        <input type="time" value="${slot.start}">
                        <span>-</span>
                        <input type="time" value="${slot.end}">
                        <select>
                            <option value="work" ${slot.type === 'work' ? 'selected' : ''}>üíº Work</option>
                            <option value="hobby" ${slot.type === 'hobby' ? 'selected' : ''}>üé® Hobby</option>
                            <option value="exercise" ${slot.type === 'exercise' ? 'selected' : ''}>üèÉ Exercise</option>
                            <option value="leisure" ${slot.type === 'leisure' ? 'selected' : ''}>üéÆ Leisure</option>
                            <option value="sleep" ${slot.type === 'sleep' ? 'selected' : ''}>üò¥ Sleep</option>
                            <option value="blocked" ${slot.type === 'blocked' ? 'selected' : ''}>üö´ Blocked</option>
                        </select>
                        <button class="btn-remove" onclick="removeSlot(this)">√ó</button>
                    `;
                    slotsDiv.appendChild(slotDiv);
                });
            });
        }

        function addTask() {
            const name = document.getElementById('taskName').value.trim();
            const duration = document.getElementById('taskDuration').value;
            const priority = document.getElementById('taskPriority').value;
            const deadline = document.getElementById('taskDeadline').value;

            if (!name || !duration || !deadline) {
                alert('‚ö†Ô∏è Please fill in all required fields (Task Name, Duration, Deadline)');
                return;
            }

            // Calculate urgency
            const deadlineDate = new Date(deadline);
            const today = new Date();
            const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
            const urgency = daysUntil <= 2 ? 'urgent' : 'normal';

            const task = {
                id: Date.now(),
                name,
                duration: parseFloat(duration),
                priority,
                deadline,
                urgency,
                daysUntil
            };

            tasks.push(task);
            displayTasks();

            // Clear form
            document.getElementById('taskName').value = '';
            document.getElementById('taskDuration').value = '';
            document.getElementById('taskDeadline').value = '';
        }

        function displayTasks() {
            const container = document.getElementById('taskList');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:20px;">No tasks added yet. Add your first task above!</p>';
                return;
            }
            
            // Sort by deadline
            const sortedTasks = [...tasks].sort((a, b) => 
                new Date(a.deadline) - new Date(b.deadline)
            );
            
            container.innerHTML = sortedTasks.map(task => `
                <div class="task-item ${task.priority}">
                    <div class="task-info">
                        <div class="task-name">
                            ${task.name}
                            <span class="task-urgency ${task.urgency}">
                                ${task.urgency === 'urgent' ? 'üî• URGENT' : 'üìÖ ' + task.daysUntil + ' days'}
                            </span>
                        </div>
                        <div class="task-details">
                            ${task.duration} hours ‚Ä¢ ${task.priority} priority ‚Ä¢ Due: ${new Date(task.deadline).toLocaleDateString()}
                        </div>
                    </div>
                    <button class="btn-remove" onclick="removeTask(${task.id})">Remove</button>
                </div>
            `).join('');
        }

        function removeTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            displayTasks();
        }

        async function generateSchedule() {
            if (tasks.length === 0) {
                alert('‚ö†Ô∏è Please add at least one task to schedule');
                return;
            }

            document.getElementById('loading').style.display = 'block';
            document.getElementById('taskSection').style.display = 'none';

            const today = new Date();
            const monday = new Date(today);
            monday.setDate(today.getDate() - today.getDay() + 1);
            const weekStart = monday.toISOString().split('T')[0];

            try {
                const response = await fetch('/api/scheduler/generate-schedule', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tasks,
                        week_start: weekStart,
                        stress_score: stressData?.stress_score || 5,
                        stress_level: stressData?.stress_level || 'Medium',
                        mood: 'neutral'
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    currentScheduleData = data.schedule;
                    document.getElementById('step2').classList.add('completed');
                    document.getElementById('step3').classList.add('active');
                    displaySchedule(data.schedule);
                } else {
                    alert('‚ùå Error generating schedule: ' + data.message);
                    document.getElementById('taskSection').style.display = 'block';
                }
            } catch (error) {
                alert('‚ùå Error: ' + error.message);
                document.getElementById('taskSection').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function displaySchedule(scheduleData) {
            document.getElementById('scheduleSection').style.display = 'block';

            // Display warnings
            if (scheduleData.warnings && scheduleData.warnings.length > 0) {
                document.getElementById('warningsContainer').innerHTML = `
                    <div class="warnings-box">
                        <h3>‚ö†Ô∏è Scheduling Warnings</h3>
                        ${scheduleData.warnings.map(w => `<div class="warning-item">${w}</div>`).join('')}
                    </div>
                `;
            }

            // Display suggestions
            if (scheduleData.suggestions && scheduleData.suggestions.length > 0) {
                document.getElementById('suggestionsContainer').innerHTML = `
                    <div class="suggestions-box">
                        <h3>üí° Optimization Suggestions</h3>
                        ${scheduleData.suggestions.map(s => `<div class="warning-item">${s}</div>`).join('')}
                    </div>
                `;
            }

            // Display workload analysis
            if (scheduleData.workload_analysis) {
                document.getElementById('workloadContainer').innerHTML = `
                    <div class="workload-grid">
                        ${Object.entries(scheduleData.workload_analysis).map(([day, load]) => `
                            <div class="workload-item ${load}">${day.substring(0, 3)}<br>${load}</div>
                        `).join('')}
                    </div>
                `;
            }

            // Display calendar
            const calendar = document.getElementById('calendarView');
            calendar.innerHTML = scheduleData.schedule.map(day => `
                <div class="day-column">
                    <div class="day-column-header">
                        <div>${day.day}</div>
                        <div style="font-size: 12px; font-weight: normal;">${new Date(day.date).toLocaleDateString()}</div>
                        <div style="font-size: 11px; color: #999;">${day.total_work_hours}h work</div>
                    </div>
                    ${day.slots.map((slot, idx) => `
                        <div class="schedule-slot ${slot.type} ${slot.urgency === 'urgent' ? 'urgent' : ''}">
                            <div class="slot-time">‚è∞ ${slot.time}</div>
                            <div class="slot-task"><strong>${slot.task}</strong></div>
                            <div style="font-size: 11px; color: #888; margin-top: 3px;">
                                ${slot.priority} priority
                                ${slot.urgency === 'urgent' ? ' ‚Ä¢ üî• URGENT' : ''}
                            </div>
                            ${slot.deadline ? `<div style="font-size: 11px; color: #ef4444; margin-top: 2px;">üìÖ Due: ${new Date(slot.deadline).toLocaleDateString()}</div>` : ''}
                            ${slot.notes ? `<div style="font-size: 11px; color: #666; margin-top: 5px;">üí≠ ${slot.notes}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            `).join('');
        }

        async function exportToGoogleCalendar() {
            // Download the .ics file which can be imported to Google Calendar
            await downloadICal();
            
            // Show instructions
            alert('üìÖ Calendar file downloaded!\n\nTo add to Google Calendar:\n1. Open Google Calendar (calendar.google.com)\n2. Click the ‚öôÔ∏è Settings icon\n3. Select "Import & Export"\n4. Click "Select file from your computer"\n5. Choose the downloaded .ics file\n6. Click "Import"\n\nAll your scheduled tasks will appear in your calendar!');
        }

        async function downloadICal() {
            if (!currentScheduleData) {
                alert('No schedule available to export');
                return;
            }

            try {
                const response = await fetch('/api/scheduler/export-calendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ schedule: currentScheduleData })
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    const blob = new Blob([data.ical_data], { type: 'text/calendar' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                } else {
                    alert('Error exporting calendar: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error exporting calendar: ' + error.message);
            }
        }

        function printSchedule() {
            window.print();
        }

        function startOver() {
            if (confirm('üîÑ Create a new schedule?\n\nThis will clear your current schedule but keep your routine saved.')) {
                tasks = [];
                currentScheduleData = null;
                
                document.getElementById('step2').classList.remove('completed', 'active');
                document.getElementById('step3').classList.remove('active');
                document.getElementById('step2').classList.add('active');
                
                document.getElementById('scheduleSection').style.display = 'none';
                document.getElementById('taskSection').style.display = 'block';
                
                displayTasks();
            }
        }

        function viewHistory() {
            alert('üìä Schedule History\n\nThis feature will show your past schedules and completion rates.\n\nComing soon!');
        }

        // Set minimum date to today for deadline picker
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            const deadlineInput = document.getElementById('taskDeadline');
            if (deadlineInput) {
                deadlineInput.min = today;
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + Enter to add task
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const taskSection = document.getElementById('taskSection');
                if (taskSection.style.display !== 'none') {
                    addTask();
                }
            }
        });
    </script>
</body>
</html>